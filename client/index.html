<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ì±„íŒ…ë°©</title>
    <style>
      body {
        font-family: Arial;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #nickname-section {
        margin-top: 30px;
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      #chat-section {
        width: 100%;
        max-width: 600px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #form {
        position: sticky;
        top: 0;
        width: 100%;
        max-width: 600px;
        display: flex;
        justify-content: center;
        padding: 10px;
        background: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        z-index: 1;
      }

      #form input {
        flex: 1;
        padding: 10px;
        font-size: 16px;
      }

      #form button {
        padding: 10px;
      }
      
      #nickname-section input {
        padding: 10px;
        font-size: 16px;
        flex: 1;
      }

      #nickname-section button {
        padding: 10px;
        font-size: 16px;
      }


      #messages {
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        max-height: 500px;
        list-style-type: none;
        padding: 0 10px;
        width: 100%;
        max-width: 600px;
        margin: 10;
      }

      .message-box {
        background-color: #e1ffc7;
        padding: 8px 12px;
        border-radius: 10px;
        margin: 5px 0;
        display: inline-block;
        max-width: 70%;
      }

      .my-message {
        background-color: #fff8b5; /* ë…¸ë‘ */
        align-self: flex-end;
      }

      .system-message {
        background-color: #e0e0e0; /* íšŒìƒ‰ */
        color: #555;
        font-style: italic;
        text-align: center;
      }

      #messages li {
        display: flex;
        justify-content: flex-start;
      }

      .time-label {
        font-size: 12px;
        color: #888;
        text-align: center;
        margin: 8px 0 4px 0;
      }
      @media (max-width: 600px) {
        body {
          font-size: 16px;
          padding: 10px;
        }

        #nickname-section {
          flex-direction: column;
          align-items: stretch;
          width: 90%;
          gap: 10px;
        }

        #nickname-input {
          font-size: 18px;
          padding: 12px;
        }

        #nickname-button {
          font-size: 18px;
          padding: 12px;
        }

        #form {
          flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
          align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
          gap: 8px;
          padding: 10px;
        }

        #form input {
          flex: 1;  /* ì…ë ¥ì°½ì´ ê°€ëŠ¥í•œ ë„“ì´ ì°¨ì§€ */
          font-size: 16px;
          padding: 10px;
        }

        #form button {
          flex: 0 0 auto;  /* ë²„íŠ¼ í¬ê¸° ê³ ì • */
          font-size: 14px;
          padding: 8px 12px;
          min-width: 60px; /* ë„ˆë¬´ ì‘ì•„ì§€ì§€ ì•Šê²Œ ìµœì†Œ í¬ê¸° ì§€ì • */
        }

        #messages {
          max-height: 60vh;
          padding: 0 5px;
        }

        .message-box {
          font-size: 16px;
          padding: 10px 14px;
        }

        .time-label {
          font-size: 12px;
        }

        h1 {
          font-size: 24px;
        }

        #user-count {
          font-size: 16px;
          margin-bottom: 10px;
        }
      }

    </style>
  </head>
  <body>
    <h1>ìš¸ ê°€ì¡± ì±„íŒ…ë°©</h1>
    <p id="user-count">0ëª… ì ‘ì† ì¤‘</p>

    <!-- ë‹‰ë„¤ì„ ì…ë ¥ -->
    <div id="nickname-section">
      <input id="nickname-input" autocomplete="off" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" />
      <button id="nickname-button">ì…ì¥</button>
    </div>

    <!-- ì±„íŒ… í™”ë©´ -->
    <div id="chat-section" style="display:none;">
      <form id="form">
        <input id="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        <button>ì „ì†¡</button>
      </form>
      <ul id="messages"></ul>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let nickname = '';
      let prevTime = null; // â¬…ï¸ ì‹œê°„ ë¹„êµ ë³€ìˆ˜

      const nicknameInput = document.getElementById('nickname-input');
      const nicknameButton = document.getElementById('nickname-button');
      const nicknameSection = document.getElementById('nickname-section');
      const chatSection = document.getElementById('chat-section');

      nicknameButton.addEventListener('click', () => {
        const name = nicknameInput.value.trim();
        if (name !== '') {
          nickname = name;
          socket.emit('set nickname', nickname);
          nicknameSection.style.display = 'none';
          chatSection.style.display = 'block';
        }
      });

      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');

      form.addEventListener('submit', function (e) {
        e.preventDefault();
        if (input.value) {
          socket.emit('chat message', `${nickname}: ${input.value}`);
          input.value = '';
        }
      });

      socket.on('chat message', function (data) {
        const item = document.createElement('li');
        const box = document.createElement('div');
        box.classList.add('message-box');

        // ì‹œê°„ ë¹„êµ ë° í‘œì‹œ
        const currentTime = data.time;
        if (prevTime === null || prevTime !== currentTime) {
          const timeElem = document.createElement('div');
          timeElem.textContent = currentTime;
          timeElem.classList.add('time-label');
          messages.prepend(timeElem);
        }
        prevTime = currentTime;

        if (data.type === 'system') {
          box.classList.add('system-message');
          box.textContent = data.text;
          item.style.justifyContent = 'center';
        } else if (data.sender === nickname) {
          box.classList.add('my-message');
          box.textContent = data.text;
          item.style.justifyContent = 'flex-end';
        } else {
          box.textContent = data.text;
          item.style.justifyContent = 'flex-start';
        }

        item.appendChild(box);
        messages.prepend(item);
      });

      socket.on('user count', function (count) {
        console.log('ğŸ‘¥ ì‚¬ìš©ì ìˆ˜ ì—…ë°ì´íŠ¸ë¨:', count);
        document.title = `ì±„íŒ…ë°© (${count}ëª… ì ‘ì† ì¤‘)`;
        document.getElementById('user-count').textContent = `${count}ëª… ì ‘ì† ì¤‘`;
      });
    </script>
  </body>
</html>
